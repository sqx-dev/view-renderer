# Application Build Script

This is the main script which is used to transform and bundle our source code into JavaScript, CSS, and HTML files that can be used directly in the application. It also performs some asset copying tasks for use in the final build.

**Note that if you've come directly here, without reading the rest of the build script documentation, the [environment generation script](<(/scripts/env/README.md)>) must be run first.**

## Contents of this folder

This folder contains the source code for the `app-build.js` script which is used to generate the final output files for the application.

The `app-build.js` script must be built before being used in a development or production build. The script when built is located at `.artifacts/app-build.js`. For more information about building this and other prerequisite scripts, see the [build documentation](/scripts/README.md).

## Script Process

This script uses [ESBuild](https://esbuild.github.io/api/) to compile and generate appropriate output code. If you want to understand any of the options within the script, the ESBuild documentation would be recommended reading. Not all options are described in detail here, although some will be mentioned.

### Reading command line flags

This script takes a single optional command line flag `--watch`. If this flag is enabled, then we create an ESBuild watcher which will build the application once, and monitor any of the included files for changes. When a change is detected, the build is run again.

The watch mode also launches a live server at http://localhost:8080 which runs the application locally.

### Selecting options

Some options are dynamic based on the build environment or process.env flags, these are listed below

#### Source Maps

If the `process.env.IS_DEV` flag is set to true, then source maps are generated inline i.e they are attached directly to the bottom of the output file.

If the `process.env.IS_DEV` flag is not set, then no source maps are generated

#### Minification

If the `process.env.IS_DEV` flag is set to true, then no minification of output occurs. If the flag is not set, then all output will be minifed.

#### Defined Values

Defined values are used to replace some source code with a predefined constant expression. You can read more about this option in the [ESBuild define documentation](https://esbuild.github.io/api/#define).

For React and many other packages, production code can be significantly smaller by completely stripping development only features from the build. This is done by replacing the value `process.env.NODE_ENV` with the string `"production"`. Most bundlers, including ESBuild are then able to perform what's known as constant folding to remove impossibilities from the code.

---

An example of this

```typescript
function doSomething() {
  if (process.env.NODE_ENV !== 'production') {
    console.warn('Calling the do something function!');
  }

  return something();
}
```

When we use the `define` option on esbuild, these source code strings are replaced directly such that the above might become

```typescript
function doSomething() {
  if ('production' !== 'production') {
    console.warn('Calling the do something function!');
  }

  return something();
}
```

The bundler is able to notice that it is impossible for the statements in the `if` block to ever be executed. Constant folding refers to this process of removing such statements constantly as it builds. The output of the constant folding might be:

```typescript
function doSomething() {
  return something();
}
```

This could even be folded further so that any calls to `doSomething` are replaced with calls to `something` instead. But that's beyond the scope of our specific build, and is an implementation detail of the bundler.

---

We define the `process.env.NODE_ENV` variable based on our own `process.env.IS_DEV` flag set while running the script. If the `IS_DEV` flag is true, this value is set to `"development"` otherwise it will be set to `"production"`.

Like many libraries, we provide code folding opportunites to the bundler with our own set of predefined flags and variables. These are imported from the `./.artifacts/define.json` file, which is generated by the [environment variables](/scripts/env/README.md) script. You can read more about this process and how our environment variables are generated there.

### Post build steps

For a description on how the build works you should view the ESBuild documentation, but once the build is complete we run several post build steps to transform the output into a valid application.

The post build steps are setup through an ESBuild plugin, which can be found at [`/scripts/app-build/post-build-plugin.ts`](/scripts/app-build/post-build-plugin.ts).

ESBuild produces a [metafile](https://esbuild.github.io/api/#build-metadata) after it has completed the build which contains information about the build artifacts and their entry points. For each item in this list, we break up the paths to produce some useful information which is used in our additional output files.

```
TODO: Injecting the scripts and styles into the HTML pages
```
